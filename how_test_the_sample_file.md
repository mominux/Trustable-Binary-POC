# Portable Project Testing Guide

This guide provides detailed steps to test the portable service generated by the project. It includes instructions for detaching and cleaning up previous instances, attaching the portable, starting the service, and verifying its functionality by interacting with the server.

---

## Table of Contents

1. Prerequisites

2. Environment Cleanup

3. Testing Steps
   
   - Step 1: Detach Previous Instances
   
   - Step 2: Free the Port and Localhost
   
   - Step 3: Attach the Portable
   
   - Step 4: Start the Service
   
   - Step 5: Test the Service

4. Troubleshooting

---

## Prerequisites

Before proceeding, ensure the following:

- The portable image (`key-value-server-1.0.0.raw`) has been successfully created in the `output/` directory.

- The environment script has been sourced:
  
  ```
  source scripts/portable_env.sh
  ```

- The required tools (`portablectl`, `systemctl`, and `telnet`) are installed on your system.

---

## Environment Cleanup

Before testing, ensure that no previous instances of the service are running, and the port is free.

### Step 1: Detach Previous Instances

1. Stop the service if it is running:
   
   ```
   sudo systemctl stop key-value-server-1.0.0
   ```

2. Detach the portable image:
   
   ```
   sudo portablectl detach output/key-value-server-1.0.0.raw
   ```

### Step 2: Free the Port and Localhost

Ensure that port `54321` (used by the server) is not in use. Use the following command to identify any processes occupying the port:

```
sudo netstat -tuln | grep 54321
```

If a process is found, terminate it:

```
sudo kill -9 <PID>
```

Replace `<PID>` with the process ID from the previous command.

---

## Testing Steps

### Step 3: Attach the Portable

Attach the portable image using `portablectl`:

```
sudo portablectl attach output/key-value-server-1.0.0.raw
```

Verify the attachment:

```
sudo portablectl list
```

You should see `key-value-server-1.0.0.raw` listed.

### Step 4: Start the Service

Start the portable service:

```
sudo systemctl start key-value-server-1.0.0
```

Check the status to confirm it is running:

```
sudo systemctl status key-value-server-1.0.0
```

Expected output:

- The service is `active (running)`.

- No errors in the logs.

### Step 5: Test the Service

Use `telnet` to connect to the service and test its functionality:

```
telnet localhost 54321
```

#### Available Commands

1. **SET**: Add a key-value pair.
   
   ```
   SET EngineStatus RUNNING
   ```
   
   Expected response: `OK`

2. **GET**: Retrieve a value by key.
   
   ```
   GET EngineStatus
   ```
   
   Expected response: `RUNNING`

3. **DELETE**: Remove a key-value pair.
   
   ```
   DELETE EngineStatus
   ```
   
   Expected response: `Deleted`

4. **EXIT**: Disconnect from the server.
   
   ```
   EXIT
   ```
   
   Expected response: `Goodbye!`

---

## Troubleshooting

### Common Issues and Fixes

1. **Port Already in Use**
   
   - Run `sudo netstat -tuln | grep 54321` and terminate the conflicting process.

2. **Service Fails to Start**
   
   - Check logs for errors:
     
     ```
     journalctl -u key-value-server-1.0.0
     ```
   
   - Ensure the `resolv.conf` file is correctly populated in `my-portable-service/etc/`.

3. **Namespace Errors**
   
   - Update the unit file (`units/key-value-server-1.0.0.service`) with the following settings in the `[Service]` section:
     
     ```
     ProtectSystem=noProtectHome=noPrivateTmp=noReadWritePaths=/etc /var /tmp /run /proc /sys
     ```
   
   - Rebuild and reattach the portable:
     
     ```
     compile_and_populatesudo portablectl attach output/key-value-server-1.0.0.raw
     ```

### Debugging Tips

- Use `systemctl status` to check the service status.

- Use `journalctl -u <service_name>` for detailed logs.
